name: CI

on: [push, pull_request]

jobs:
  test-ios:
    runs-on: macOS-latest
    steps:
    - uses: actions/checkout@v1

    - name: Generate Xcode Project
      run: swift package generate-xcodeproj --enable-code-coverage

    - name: Build and Test
      run: |
        set -o pipefail && xcodebuild clean build test \
          -project "TrackedValue.xcodeproj" \
          -scheme "TrackedValue-Package" \
          -destination "platform=iOS Simulator,OS=latest,name=iPhone XS" | xcpretty -c

    - name: Upload Code Coverage
      run: |
        bash <(curl -s https://codecov.io/bash)
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  test-macos:
    runs-on: macOS-latest
    strategy:
      matrix:
        xcode:
          - /Applications/Xcode_10.3.app
          - /Applications/Xcode_10.1.app
    steps:
    - uses: actions/checkout@v1

    - name: Test
      run: |
        swift --version
        swift test --parallel
      env:
        DEVELOPER_DIR: ${{ matrix.xcode }}

  test-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        swift_version:
          - "5.0"
          - "4.2.1"
    steps:
    - uses: actions/checkout@v1
    
    - name: Test
      run: |
        eval "$(curl -sL https://swiftenv.fuller.li/install.sh)"
        swift --version
        swift test --parallel
      env:
        SWIFT_VERSION: ${{ matrix.swift_version }}
